---
title: "assignment3"
author: "Anna Calle"
date: "4/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sensitivity)
library(pse)
```

Adjust your almond model to output ONLY the mean almond yield anomoly IF the users sets parameter (e.g mean_only = TRUE))

Perform a sensitivity analysis of how mean anomaly varies ALL of the parameters used in the yield model  

Assume parameters are normally distributed with standard deviation of 20% mean value

Rank the parameters in term of their sensitivity

Graph uncertainty in mean yield anomaly across all parameter uncertainty (boxplot and cummulative distribution of the output).

Repeat using the LHS and Sobol methods

Repeat using twice as many parameter sets as you did in your first sensitivity analysis - and look at how this changes the sensitivity results

Submit R markdown and short write up describing what you learned from the sensitivity analysis. Please submit your markdown as an .html or PDF. 

```{r}
# read in the input data
clim <- read.table("clim.txt",  sep=" ", header=T)

# source function
source("almond_yield.R")

almond_yield(mean_only = TRUE)
```


LHS
```{r}
# names of our parameters: a = "Tmincoeff1", b = "Tmincoeff2", c = "Precipcoeff1", d = "Precipcoeff2", e = "Intercept"
factors = c("a", "b", "c", "d", "e")

# type of distributions they arise from
q = c("qnorm", "qnorm", "qnorm", "qnorm", "qnorm")

# parameters mean
a = -0.015
b = -0.0046
c = -0.07
d = 0.0043
e = 0.28

# parameters for those distributions
q.arg = list(list(mean=a, sd=0.2),
             list(mean=b, sd=0.2),
             list(mean=c, sd=0.2),
             list(mean=d, sd=0.2),
             list(mean=e, sd=0.2))

nsets=200
sens_YA = LHS(NULL,factors,nsets,q,q.arg)

# save parameter values
sens.pars = get.data(sens_YA)
head(sens.pars)
```

```{r}
# run model
sens_results= mapply(FUN=almond_yield, a=sens.pars$a, b=sens.pars$b, c=sens.pars$c, d=sens.pars$d, e=sens.pars$e, MoreArgs=list(clim_data = clim, mean_only=TRUE))
head(sens_results)

# use unlist to get a matrix
sens_res = matrix((unlist(sens_results)), ncol=1, byrow=TRUE)

sens_YA = pse::tell(sens_YA, t(sens_res), res.names="YA")
plotscatter(sens_YA)

# note it can take standard R plotting parameters
plotscatter(sens_YA, col="darkgreen", cex=5, ylab="Yield Anomaly (ton/acre)")

# whats is the range of results
plotecdf(sens_YA, col="red", lwd=5, xlab="Yield Anomaly (ton/acre)")

# we can also plot partial correlation coefficients
plotprcc(sens_YA)

# rank parameters
sens_YA_prcc <- sens_YA$prcc[[1]]$PRCC %>%
  mutate(param = c("a", "b", "c", "d", "e")) %>% 
  arrange(-(abs(original)))

colnames(sens_YA_prcc) <-  c("PRCC", "Parameter")
sens_YA_prcc

# boxplot
sens_YA_df <- sens_YA$data %>%
  gather(param, YA)

lhs_boxplot <- ggplot(sens_YA_df, aes(param, YA, fill=param)) +
  geom_boxplot() + 
  labs(y="Yield Anomaly (ton/acre)", x = "Parameter")

lhs_boxplot

```

Sobol

```{r}
# names of our parameters
# number of parameters 

np=200
a = rnorm(mean=a, sd=0.2, n=np)
b = rnorm(mean=b, sd=0.2, n=np)
c = rnorm(mean=c, sd=0.2, n=np)
d = rnorm(mean=d, sd=0.2, n=np)
e = rnorm(mean=e, sd=0.2, n=np)

# generate two examples of random number from parmeter distributions

X1 = cbind.data.frame(a, b, c, d, e)

# repeat sampling
a = rnorm(mean=a, sd=0.2, n=np)
b = rnorm(mean=b, sd=0.2, n=np)
c = rnorm(mean=c, sd=0.2, n=np)
d = rnorm(mean=d, sd=0.2, n=np)
e = rnorm(mean=e, sd=0.2, n=np)

X2 = cbind.data.frame(a, b, c, d, e)

sens_YA_sobel = sobol2007(model = NULL, X1, X2, nboot = 100)


# run model for all parameter sets
res = mapply(FUN=almond_yield,  a=sens_YA_sobel$X$a,
             b=sens_YA_sobel$X$b,
             c=sens_YA_sobel$X$c,
             d=sens_YA_sobel$X$d,
             e=sens_YA_sobel$X$e,
             MoreArgs=list(clim_data = clim, mean_only=TRUE))


sens_YA_sobel = sensitivity::tell(sens_YA_sobel,res, res.names="YA")

# first-order indices (main effect without co-variance)
sens_YA_sobel$S

# total sensitivity index -note that this partitions the output variance - so values sum to 1
sens_YA_sobel$T

# The difference between the main effect and total effect can tell us something about how the parameter influences results
# so in the main effect we include interactions with other parameters
print(sens_YA_sobel)
plot(sens_YA_sobel)

# compare with LHS and PRCC
sens_YA$prcc
sens_YA_sobel$S
sens_YA_sobel$T

# make a data frame for plotting
both = cbind.data.frame(sens_YA_sobel$X, gs=sens_YA_sobel$y)

# look at response of conductance to the two most important variables
 ggplot(both, aes(d, e))+geom_point()+labs(y="Coefficient d", x="Coefficient e")
 
 # rank S
 rank_S <- sens_YA_sobel$S %>%
   select(original) %>% 
   mutate(param = c("a", "b", "c", "d", "e")) %>% 
  arrange(-(abs(original)))

colnames(rank_S) <-  c("PRCC", "Parameter")
rank_S

 # rank T
 rank_T <- sens_YA_sobel$T %>%
   select(original) %>% 
   mutate(param = c("a", "b", "c", "d", "e")) %>% 
  arrange(-(abs(original)))

colnames(rank_T) <-  c("PRCC", "Parameter")
rank_T
 
 # boxplot
sens_YA_sobel_df <- sens_YA_sobel$X %>%
  gather(param, YA)

sobol_boxplot <- ggplot(sens_YA_sobel_df, aes(param, YA, fill=param)) +
  geom_boxplot() + 
  labs(y="Yield Anomaly (ton/acre)", x = "Parameter")

sobol_boxplot

```




